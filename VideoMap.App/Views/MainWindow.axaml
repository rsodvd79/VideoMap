<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:VideoMap.App.ViewModels"
        xmlns:models="using:VideoMap.App.Models"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="450"
        x:Class="VideoMap.App.Views.MainWindow"
        x:DataType="vm:MainWindowViewModel"
        Icon="/Assets/avalonia-logo.ico"
        Title="VideoMap Designer"
        Width="1200"
        Height="800"
        Background="#1C1C1C">

    <Design.DataContext>
        <!-- This only sets the DataContext for the previewer in an IDE,
             to set the actual DataContext for runtime, set the DataContext property in code (look at App.axaml.cs) -->
        <vm:MainWindowViewModel/>
    </Design.DataContext>

    <Grid RowDefinitions="Auto,*" ColumnDefinitions="260,*,300">
        <Border Grid.Row="0" Grid.ColumnSpan="3" Background="#202020" Padding="12">
            <Grid ColumnDefinitions="*,Auto">
                <StackPanel Orientation="Horizontal" Spacing="8">
                    <Button Content="Nuovo" Command="{Binding NewProjectCommand}" />
                    <Button Content="Carica" Click="OnLoadProjectClick" />
                    <Button Content="Salva" Click="OnSaveProjectClick" />
                    <Button Content="Esporta preset" Click="OnExportPresetClick" />
                    <Button Content="Aggiungi poligono"
                            Command="{Binding StartPolygonCommand}"
                            CommandParameter="{Binding Bounds, ElementName=DesignSurface}" />
                    <Button Content="Completa poligono" Command="{Binding CompletePolygonCommand}" IsEnabled="{Binding IsDrawingPolygon}" />
                    <Button Content="Apri preview" Click="OnOpenPreviewClick" />
                    <TextBlock Text="{Binding StatusMessage}"
                               Margin="16,0,0,0"
                               VerticalAlignment="Center"
                               Foreground="#CFCFCF" />
                </StackPanel>
                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                    <Button Content="Play" Command="{Binding PlayAllCommand}" />
                    <Button Content="Pausa" Command="{Binding PauseAllCommand}" />
                    <Button Content="Stop" Command="{Binding StopAllCommand}" />
                    <Slider Width="160"
                            Minimum="0"
                            Maximum="1"
                            Value="{Binding PlaybackPosition}"
                            ValueChanged="OnPlaybackSeekChanged" />
                </StackPanel>
            </Grid>
        </Border>

        <Border Grid.Row="1" Grid.Column="0" Background="#252525" Padding="12">
            <ScrollViewer>
                <StackPanel Spacing="12">
                    <TextBlock Text="Poligoni" FontWeight="SemiBold" Foreground="#E0E0E0" />
                    <ListBox ItemsSource="{Binding Polygons}" SelectedItem="{Binding SelectedPolygon}">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <StackPanel Spacing="2">
                                    <TextBlock Text="{Binding Name}" Foreground="#E0E0E0" />
                                    <TextBlock Text="{Binding MediaPath}"
                                               FontSize="11"
                                               Foreground="#9A9A9A"
                                               TextTrimming="CharacterEllipsis" />
                                    <TextBlock Text="MANCANTE"
                                               FontSize="11"
                                               Foreground="#FF6B6B"
                                               IsVisible="{Binding IsMediaMissing}" />
                                </StackPanel>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <Button Content="Rimuovi" Command="{Binding RemovePolygonCommand}" IsEnabled="{Binding HasSelection}" />
                        <Button Content="Importa media" Click="OnImportMediaClick" IsEnabled="{Binding HasSelection}" />
                        <Button Content="Ricollega" Click="OnRelinkMediaClick" IsEnabled="{Binding HasSelection}" />
                        <Button Content="Ricollega mancanti" Click="OnRelinkMissingMediaClick" />
                    </StackPanel>

                    <TextBlock Text="Scene" FontWeight="SemiBold" Foreground="#E0E0E0" Margin="0,8,0,0" />
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <Button Content="Aggiungi scena" Command="{Binding AddSceneCommand}" />
                        <Button Content="Rimuovi" Command="{Binding RemoveSceneCommand}" IsEnabled="{Binding HasSceneSelection}" />
                    </StackPanel>
                    <ListBox ItemsSource="{Binding Scenes}" SelectedItem="{Binding SelectedScene}">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <StackPanel Spacing="2">
                                    <TextBlock Text="{Binding Name}" Foreground="#E0E0E0" />
                                    <TextBlock Text="{Binding DurationSeconds, StringFormat='{}{0:0.0}s'}"
                                               FontSize="11"
                                               Foreground="#9A9A9A" />
                                </StackPanel>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                    <StackPanel IsVisible="{Binding HasSceneSelection}" Spacing="6">
                        <TextBlock Text="Nome scena" Foreground="#BFBFBF" />
                        <TextBox Text="{Binding SelectedScene.Name}" />
                        <TextBlock Text="Durata (s)" Foreground="#BFBFBF" />
                        <TextBox Text="{Binding SelectedScene.DurationSeconds}" />
                    </StackPanel>
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <Button Content="Applica" Command="{Binding ApplySceneCommand}" IsEnabled="{Binding HasSceneSelection}" />
                        <Button Content="Play" Command="{Binding PlaySceneCommand}" IsEnabled="{Binding HasSceneSelection}" />
                        <Button Content="Stop" Command="{Binding StopSceneCommand}" IsEnabled="{Binding IsScenePlaying}" />
                    </StackPanel>
                    <ProgressBar Minimum="0" Maximum="1" Value="{Binding SceneProgress}" />
                    <TextBlock Text="{Binding SceneStatus}" FontSize="11" Foreground="#9A9A9A" />
                    <TextBlock Text="Poligoni scena" FontWeight="SemiBold" Foreground="#E0E0E0" />
                    <ItemsControl ItemsSource="{Binding SceneAssignments}" IsVisible="{Binding HasSceneSelection}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <CheckBox Content="{Binding Name}" IsChecked="{Binding IsAssigned}" />
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>

                    <TextBlock Text="Output" FontWeight="SemiBold" Foreground="#E0E0E0" Margin="0,8,0,0" />
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <Button Content="Aggiungi output" Command="{Binding AddOutputCommand}" />
                        <Button Content="Rimuovi" Command="{Binding RemoveOutputCommand}" IsEnabled="{Binding HasOutputSelection}" />
                    </StackPanel>
                    <ListBox ItemsSource="{Binding Outputs}" SelectedItem="{Binding SelectedOutput}">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <StackPanel Spacing="2">
                                    <TextBlock Text="{Binding Name}" Foreground="#E0E0E0" />
                                    <TextBlock Text="{Binding Width, StringFormat='Larghezza {0:0}px'}"
                                               FontSize="11"
                                               Foreground="#9A9A9A" />
                                    <TextBlock Text="{Binding Height, StringFormat='Altezza {0:0}px'}"
                                               FontSize="11"
                                               Foreground="#9A9A9A" />
                                </StackPanel>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                    <TextBlock Text="Poligoni output" FontWeight="SemiBold" Foreground="#E0E0E0" />
                    <ItemsControl ItemsSource="{Binding OutputAssignments}" IsVisible="{Binding HasOutputSelection}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <CheckBox Content="{Binding Name}" IsChecked="{Binding IsAssigned}" />
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>

                    <TextBlock Text="Media" FontWeight="SemiBold" Foreground="#E0E0E0" Margin="0,8,0,0" />
                    <ListBox ItemsSource="{Binding MediaLibrary}" IsVisible="{Binding HasMediaLibrary}">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <StackPanel Spacing="2">
                                    <TextBlock Text="{Binding DisplayName}" Foreground="#E0E0E0" />
                                    <TextBlock Text="{Binding MediaType}" FontSize="11" Foreground="#9A9A9A" />
                                    <TextBlock Text="{Binding UsageLabel}" FontSize="11" Foreground="#9A9A9A" />
                                    <TextBlock Text="MANCANTE"
                                               FontSize="11"
                                               Foreground="#FF6B6B"
                                               IsVisible="{Binding IsMissing}" />
                                </StackPanel>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </StackPanel>
            </ScrollViewer>
        </Border>

        <Border Grid.Row="1" Grid.Column="1" Background="#111111" Padding="12">
            <Grid>
                <Canvas x:Name="DesignSurface"
                        Background="#111111"
                        PointerPressed="OnDesignerPointerPressed"
                        PointerMoved="OnDesignerPointerMoved"
                        PointerReleased="OnDesignerPointerReleased">
                    <ItemsControl ItemsSource="{Binding Polygons}"
                                  IsHitTestVisible="False"
                                  Width="{Binding Bounds.Width, ElementName=DesignSurface}"
                                  Height="{Binding Bounds.Height, ElementName=DesignSurface}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <Canvas />
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Canvas Width="{Binding Bounds.Width, ElementName=DesignSurface}"
                                        Height="{Binding Bounds.Height, ElementName=DesignSurface}">
                                    <Image Source="{Binding WarpedBitmap}"
                                           Width="{Binding Bounds.Width}"
                                           Height="{Binding Bounds.Height}"
                                           Canvas.Left="{Binding Bounds.X}"
                                           Canvas.Top="{Binding Bounds.Y}"
                                           IsVisible="{Binding IsWarpedVisible}" />
                                    <Polygon Points="{Binding RenderPoints}"
                                             Fill="{Binding ImageFill}"
                                             StrokeThickness="0"
                                             IsVisible="{Binding HasImageClip}" />
                                </Canvas>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                    <ItemsControl ItemsSource="{Binding VideoLayers}"
                                  IsHitTestVisible="False"
                                  Width="{Binding Bounds.Width, ElementName=DesignSurface}"
                                  Height="{Binding Bounds.Height, ElementName=DesignSurface}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <Canvas />
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Canvas>
                                    <Image Source="{Binding WarpedVideoBitmap}"
                                           Width="{Binding Bounds.Width}"
                                           Height="{Binding Bounds.Height}"
                                           Canvas.Left="{Binding Bounds.X}"
                                           Canvas.Top="{Binding Bounds.Y}"
                                           IsVisible="{Binding IsWarpedVisible}" />
                                    <Image Source="{Binding VideoBitmap}"
                                           Clip="{Binding ClipGeometry}"
                                           Canvas.Left="0"
                                           Canvas.Top="0"
                                           Width="{Binding Bounds.Width, ElementName=DesignSurface}"
                                           Height="{Binding Bounds.Height, ElementName=DesignSurface}"
                                           Stretch="Fill"
                                           IsVisible="{Binding IsClipVisible}" />
                                </Canvas>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                    <ItemsControl ItemsSource="{Binding Polygons}"
                                  Width="{Binding Bounds.Width, ElementName=DesignSurface}"
                                  Height="{Binding Bounds.Height, ElementName=DesignSurface}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <Canvas />
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Polygon Points="{Binding RenderPoints}"
                                         Stroke="#E2E2E2"
                                         StrokeThickness="2"
                                         Fill="#22FFFFFF"
                                         PointerPressed="OnPolygonPointerPressed"
                                         IsVisible="{Binding IsSceneVisible}" />
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                    <ItemsControl ItemsSource="{Binding SelectedPolygon.Points}"
                                  Width="{Binding Bounds.Width, ElementName=DesignSurface}"
                                  Height="{Binding Bounds.Height, ElementName=DesignSurface}"
                                  IsVisible="{Binding HasSelection}">
                        <ItemsControl.ItemContainerTheme>
                            <ControlTheme TargetType="ContentPresenter" x:DataType="models:PointModel">
                                <Setter Property="Canvas.Left" Value="{Binding X}" />
                                <Setter Property="Canvas.Top" Value="{Binding Y}" />
                            </ControlTheme>
                        </ItemsControl.ItemContainerTheme>
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <Canvas />
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Ellipse Width="10"
                                         Height="10"
                                         Fill="#FFEB3B"
                                         Stroke="#1B1B1B"
                                         StrokeThickness="1"
                                         Canvas.Left="{Binding X}"
                                         Canvas.Top="{Binding Y}"
                                         PointerPressed="OnVertexPointerPressed">
                                    <Ellipse.RenderTransform>
                                        <TranslateTransform X="-5" Y="-5" />
                                    </Ellipse.RenderTransform>
                                </Ellipse>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </Canvas>
                <TextBlock Text="Area di progettazione"
                           Foreground="#777777"
                           HorizontalAlignment="Center"
                           VerticalAlignment="Center"
                           IsVisible="{Binding HasNoPolygons}" />
            </Grid>
        </Border>

        <Border Grid.Row="1" Grid.Column="2" Background="#252525" Padding="12">
            <StackPanel Spacing="10">
                <TextBlock Text="Proprieta" FontWeight="SemiBold" Foreground="#E0E0E0" />
                <StackPanel IsVisible="{Binding HasOutputSelection}" Spacing="8">
                    <TextBlock Text="Output" Foreground="#BFBFBF" />
                    <TextBox Text="{Binding SelectedOutput.Name}" />
                    <TextBlock Text="Larghezza" Foreground="#BFBFBF" />
                    <TextBox Text="{Binding SelectedOutput.Width}" />
                    <TextBlock Text="Altezza" Foreground="#BFBFBF" />
                    <TextBox Text="{Binding SelectedOutput.Height}" />
                </StackPanel>
                <StackPanel IsVisible="{Binding HasSelection}" Spacing="8">
                    <TextBlock Text="Nome" Foreground="#BFBFBF" />
                    <TextBox Text="{Binding SelectedPolygon.Name}" />
                    <TextBlock Text="Media" Foreground="#BFBFBF" />
                    <TextBox Text="{Binding SelectedPolygon.MediaPath}" IsReadOnly="True" />
                    <TextBlock Text="Media mancante"
                               Foreground="#FF6B6B"
                               IsVisible="{Binding SelectedPolygon.IsMediaMissing}" />
                    <TextBlock Text="Tipo media" Foreground="#BFBFBF" />
                    <TextBlock Text="{Binding SelectedPolygon.MediaType}" Foreground="#CFCFCF" />
                    <TextBlock Text="Ordine" Foreground="#BFBFBF" />
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock Text="{Binding SelectedPolygon.Order}" Foreground="#CFCFCF" VerticalAlignment="Center" />
                        <Button Content="Su" Command="{Binding MovePolygonUpCommand}" />
                        <Button Content="Giu" Command="{Binding MovePolygonDownCommand}" />
                    </StackPanel>
                    <TextBlock Text="Vertici" Foreground="#BFBFBF" />
                    <TextBlock Text="{Binding SelectedPolygon.Points.Count}" Foreground="#CFCFCF" />
                    <StackPanel IsVisible="{Binding IsSelectedPolygonVideo}" Spacing="6">
                        <TextBlock Text="Video" Foreground="#BFBFBF" />
                        <CheckBox Content="Solo" IsChecked="{Binding SelectedPolygon.IsVideoSolo}" />
                        <CheckBox Content="Mute" IsChecked="{Binding SelectedPolygon.IsVideoMuted}" />
                        <CheckBox Content="Loop" IsChecked="{Binding SelectedPolygon.IsVideoLoop}" />
                    </StackPanel>
                </StackPanel>
                <StackPanel Spacing="6">
                    <TextBlock Text="LibVLC" Foreground="#BFBFBF" />
                    <TextBlock Text="Percorso VLC (Contents/MacOS)" Foreground="#8F8F8F" FontSize="11" />
                    <TextBox Text="{Binding VlcBasePath}"
                             Watermark="/Applications/VLC.app/Contents/MacOS" />
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <Button Content="Sfoglia" Click="OnBrowseVlcPathClick" />
                        <Button Content="Applica" Click="OnApplyVlcPathClick" />
                        <Button Content="Reset" Click="OnResetVlcPathClick" />
                    </StackPanel>
                    <TextBlock Text="{Binding LibVlcStatus}"
                               TextWrapping="Wrap"
                               Foreground="#8F8F8F"
                               FontSize="11" />
                </StackPanel>
                <TextBlock IsVisible="{Binding HasNoSelectionAndNoOutput}"
                           Text="Seleziona un poligono o un output per modificarne i parametri."
                           TextWrapping="Wrap"
                           Foreground="#C0C0C0" />
            </StackPanel>
        </Border>
    </Grid>

</Window>
